<script>
        // Variáveis globais
        let productA = null;
        let productB = null;

        // --- SEU LINK DE AFILIADO ---
        function generateAffiliateLink(originalLink) {
            // Coloque sua lógica aqui depois. 
            return originalLink; 
        }

        // FUNÇÃO DE BUSCA BLINDADA (Tenta Direto -> Se falhar, Tenta Proxy)
        async function searchProduct(side) {
            const inputId = side === 'A' ? 'inputA' : 'inputB';
            const query = document.getElementById(inputId).value;
            const statusMsg = document.getElementById('statusMessage');

            if (!query) return alert("Digite algo para buscar!");

            // Mostra loading e limpa erros anteriores
            statusMsg.classList.remove('hidden');
            statusMsg.innerHTML = '<div class="spinner"></div><span>Buscando ' + query + '...</span>';

            try {
                let data = null;
                const targetUrl = `https://api.mercadolibre.com/sites/MLB/search?q=${encodeURIComponent(query)}&limit=1`;

                try {
                    // TENTATIVA 1: Direta (Mais rápida)
                    console.log("Tentando conexão direta...");
                    const response = await fetch(targetUrl);
                    if (!response.ok) throw new Error("Falha na direta");
                    data = await response.json();
                
                } catch (directError) {
                    // TENTATIVA 2: Via Proxy (Caminho alternativo se a direta for bloqueada)
                    console.warn("Direta falhou, tentando Proxy...", directError);
                    // Usando um proxy diferente e mais estável para JSON
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;
                    
                    const proxyResponse = await fetch(proxyUrl);
                    if (!proxyResponse.ok) throw new Error("Erro no Proxy: " + proxyResponse.status);
                    
                    const proxyJson = await proxyResponse.json();
                    // O AllOrigins retorna o JSON dentro de "contents" como string, precisamos converter
                    if (proxyJson.contents) {
                        data = JSON.parse(proxyJson.contents);
                    } else {
                        throw new Error("Proxy não retornou dados.");
                    }
                }

                // PROCESSAMENTO DOS DADOS (Igual ao anterior)
                if (data && data.results && data.results.length > 0) {
                    const item = data.results[0];
                    
                    if (side === 'A') productA = item;
                    else productB = item;

                    renderCard(side, item);
                    
                    if (productA && productB) comparePrices();

                    const arena = document.getElementById('arena');
                    arena.classList.remove('hidden');
                    setTimeout(() => arena.classList.remove('opacity-0'), 100);
                    
                } else {
                    alert("Nenhum produto encontrado para: " + query);
                }

            } catch (error) {
                console.error("Erro Fatal:", error);
                // AQUI ESTÁ A MUDANÇA: O erro vai aparecer na tela para sabermos o que é
                alert("Ops! Erro técnico: " + error.message + "\n\nTente buscar termos mais simples (ex: 'iphone' em vez de 'iphone 13 pro max novo').");
            } finally {
                statusMsg.classList.add('hidden');
            }
        }

        function renderCard(side, item) {
            // Tenta melhorar imagem
            let imgUrl = item.thumbnail ? item.thumbnail.replace('I.jpg', 'W.jpg') : ''; 
            
            document.getElementById(`img${side}`).src = imgUrl;
            document.getElementById(`title${side}`).innerText = item.title;
            
            const priceFormatted = item.price.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById(`price${side}`).innerText = priceFormatted;
            
            document.getElementById(`link${side}`).href = generateAffiliateLink(item.permalink);
        }

        function comparePrices() {
            if(!productA || !productB) return;

            const priceA = productA.price;
            const priceB = productB.price;
            
            const badgeA = document.getElementById('badgeA');
            const badgeB = document.getElementById('badgeB');
            const textA = document.getElementById('priceA');
            const textB = document.getElementById('priceB');

            badgeA.classList.add('hidden');
            badgeB.classList.add('hidden');
            textA.classList.remove('text-green-400', 'text-white');
            textB.classList.remove('text-green-400', 'text-white');

            if (priceA < priceB) {
                badgeA.classList.remove('hidden');
                textA.classList.add('text-neon');
                textB.classList.add('text-white');
            } else if (priceB < priceA) {
                badgeB.classList.remove('hidden');
                textB.classList.add('text-neon');
                textA.classList.add('text-white');
            }
        }

        function handleEnter(e, side) {
            if (e.key === 'Enter') searchProduct(side);
        }
    </script>
